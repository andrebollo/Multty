<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>MULtty - Serial Terminal</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: monospace; margin: 0; background: #0c0c0c; color: #cccccc; height: 100vh; display: flex; flex-direction: column; }
        header { background: #1e1e1e; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; }
        .controls input { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 3px; }
        .btn-serial { background: #e91e63; color: white; border: none; padding: 8px 15px; cursor: pointer; font-weight: bold; border-radius: 3px; }
        .btn-serial.connected { background: #4caf50; }
        .title { font-size: 2rem; color: #00ff00; font-weight: bold; }
        
        main { display: flex; flex: 1; min-height: 0; padding: 10px; gap: 10px; }
        .left-panel { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; border-radius: 5px; padding: 10px; }
        .right-panel { flex: 3; display: flex; flex-direction: column; }

        #terminal { flex: 1; background: black; color: #00ff00; padding: 15px; border-radius: 5px; overflow-y: auto; white-space: pre-wrap; font-size: 14px; outline: none; border: 1px solid #333; }
        #chat-box { flex: 1; overflow-y: auto; font-size: 0.9em; margin-bottom: 10px; border-bottom: 1px solid #333; }
        #chat-input { background: #222; border: 1px solid #444; color: white; width: 100%; padding: 8px; }
        #user-list { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<header>
    <div class="controls">
        <input type="text" id="username" placeholder="Usuário">
        <input type="text" id="room" placeholder="Sala">
        <button onclick="join()" style="background: #1a237e; color: white; border: none; padding: 8px;">Entrar</button>
        <button id="serial-btn" class="btn-serial" onclick="connectSerial()">CONECTAR SERIAL</button>
    </div>
    <div class="title">MULtty</div>
</header>

<main>
    <section class="left-panel">
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Chat..." onkeypress="handleChat(event)">
        <div id="user-list">Na sala: <span id="users">-</span></div>
    </section>

    <section class="right-panel">
        <div id="terminal" tabindex="0">Aguardando entrada...</div>
    </section>
</main>

<script>
    const socket = io();
    const term = document.getElementById('terminal');
    let port, writer, reader;

    // --- Lógica Serial ---
    async function connectSerial() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            const btn = document.getElementById('serial-btn');
            btn.innerText = "SERIAL ONLINE";
            btn.classList.add('connected');
            
            writer = port.writable.getWriter();
            readSerial();
        } catch (err) {
            console.error('Erro Serial:', err);
            alert("Falha ao conectar Serial. Verifique as permissões.");
        }
    }

    async function readSerial() {
        reader = port.readable.getReader();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = new TextDecoder().decode(value);
                updateTerminal(text, true); // Envia o que recebeu para os outros
            }
        } finally {
            reader.releaseLock();
        }
    }

    // --- Lógica de Sincronização ---
    function join() {
        const u = document.getElementById('username').value;
        const r = document.getElementById('room').value;
        if(u && r) socket.emit('join-room', { room: r, user: u });
    }

    function updateTerminal(data, shouldBroadcast) {
        term.innerText += data;
        term.scrollTop = term.scrollHeight;
        if (shouldBroadcast) socket.emit('terminal-input', data);
    }

    socket.on('terminal-init', (data) => term.innerText = data);
    socket.on('terminal-output', (data) => updateTerminal(data, false));

    // Captura teclas especiais e envia para o Serial
    term.addEventListener('keydown', async (e) => {
        e.preventDefault();
        let data = e.key;
        
        // Tratamento simples de teclas especiais
        if (e.key === 'Enter') data = '\r\n';
        if (e.key === 'Backspace') data = '\x08';
        if (e.key === 'Tab') data = '\t';
        if (e.ctrlKey && e.key === 'c') data = '\x03'; // Ctrl+C

        if (writer) {
            await writer.write(new TextEncoder().encode(data));
        }
        // Se você quer que os outros vejam o que VOCÊ digitou (echo)
        // Alguns equipamentos fazem echo automático, se não fizerem, descomente abaixo:
        // updateTerminal(data, true); 
    });

    // --- Chat ---
    function handleChat(e) {
        if (e.key === 'Enter') {
            socket.emit('send-msg', { user: document.getElementById('username').value, msg: e.target.value });
            e.target.value = '';
        }
    }
    socket.on('new-msg', d => {
        document.getElementById('chat-box').innerHTML += `<div><strong>${d.user}:</strong> ${d.msg}</div>`;
    });
</script>
</body>
</html>
